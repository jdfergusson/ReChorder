<meta name="viewport" content="width=device-width, initial-scale=1.0">
<html>
<head>
    <style>
    .block {
      color: maroon;
      float: none;
    }

    .container {
        display: flex;
        justify-content: flex-start;
    }
    </style>


    <script src="https://code.jquery.com/jquery-3.1.0.min.js"></script>
    <script type="text/javascript">
        {% if not am_i_master %}
            function checkForUpdates() {
                $.ajax({
                    url: '{% url 'slave_key' set_id %}',
                    success: function (data)
                    {
                        if (data.update_key != {{ update_key }})
                        {
                            location.reload();
                        }
                    }
                });
            }
        {% endif %}

        function doTranspose(key_index)
        {
            $.ajax({
                url: '{% url 'song.transpose' %}',
                data: {
                    'target_key_index': key_index,
                    'song_id': {{ song_id }},
                    'set_id': {{ set_id }},
                },
                success: updateSong,
            });
        }

        function updateSong(data) {
            /* Data should contain object with song_html and key_index */
            $('#song').html(data.song_html);
            $('#target-key')[0].value = data.key_index;
        }

        function resetTransposition()
        {
            doTranspose(-1);
        }

        function transposeSong() {
            sel = $('#target-key')[0];
            doTranspose(sel.options[sel.selectedIndex].value);
        }

        {% if am_i_master %}
        function processKeyPress(e) {
            e = e || window.event;

            {% if current_index > 0 %}
                if (e.key == 'PageUp') {
                    if (window.scrollY <= 0)
                    {
                        window.location.href = "{% url 'set.song' current_index|add:'-1' %}";
                    }
                }
            {% endif %}

            {% if current_index < max_index %}
            if (e.key == 'PageDown') {
                if (window.innerHeight + window.scrollY >= document.body.offsetHeight)
                {
                    window.location.href = "{% url 'set.song' current_index|add:'1' %}";
                }
            }
            {% endif %}
        }
        {% endif %}


        $(function() {
            /* Check for an update every second */
            {% if not am_i_master %}
                window.setInterval(checkForUpdates, 1000);
            {% endif %}

            {% if song %}
            $('#target-key')[0].value = {{ song.key.index }};
            $('#target-key').change(transposeSong);
            $('#key-reset').click(resetTransposition);
            {% endif %}

            {% if am_i_master %}
                document.onkeydown = processKeyPress;
            {% endif %}
        });

    </script>

</head>
<body>
<p>

{% if song %}
    <h1>{{ song.title }}</h1>
    {{ song.artist }}

    <p>
        <select id="target-key">
        {% for key in keys %}
            <option value="{{ forloop.counter0 }}">{{ key }}</option>
        {% endfor %}
        </select>
        <button id="key-reset">Reset</button>
    </p>

    {% if am_i_master %}
        {% if current_index > 0 %}<a href="{% url 'set.song' current_index|add:'-1' %}">Previous</a>{% endif %}
        {% if current_index < max_index %}<a href="{% url 'set.song' current_index|add:'1' %}">Next</a>{% endif %}
    {% endif %}

    <span id="song">
        {% include "songview/_print_song.html" %}
    </span>
{% else %}
    <h1>No song. Waiting for beaming to start...</h1>
{% endif %}

</body>
</html>