<meta name="viewport" content="width=device-width, initial-scale=1.0">
<html>
<head>
    <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <!--<script src="http://code.jquery.com/ui/1.8.24/jquery-ui.min.js"></script>-->

    <!-- (Start) Add jQuery UI Touch Punch -->
    <script>!function(a){function f(a,b){if(!(a.originalEvent.touches.length>1)){a.preventDefault();var c=a.originalEvent.changedTouches[0],d=document.createEvent("MouseEvents");d.initMouseEvent(b,!0,!0,window,1,c.screenX,c.screenY,c.clientX,c.clientY,!1,!1,!1,!1,0,null),a.target.dispatchEvent(d)}}if(a.support.touch="ontouchend"in document,a.support.touch){var e,b=a.ui.mouse.prototype,c=b._mouseInit,d=b._mouseDestroy;b._touchStart=function(a){var b=this;!e&&b._mouseCapture(a.originalEvent.changedTouches[0])&&(e=!0,b._touchMoved=!1,f(a,"mouseover"),f(a,"mousemove"),f(a,"mousedown"))},b._touchMove=function(a){e&&(this._touchMoved=!0,f(a,"mousemove"))},b._touchEnd=function(a){e&&(f(a,"mouseup"),f(a,"mouseout"),this._touchMoved||f(a,"click"),e=!1)},b._mouseInit=function(){var b=this;b.element.bind({touchstart:a.proxy(b,"_touchStart"),touchmove:a.proxy(b,"_touchMove"),touchend:a.proxy(b,"_touchEnd")}),c.call(b)},b._mouseDestroy=function(){var b=this;b.element.unbind({touchstart:a.proxy(b,"_touchStart"),touchmove:a.proxy(b,"_touchMove"),touchend:a.proxy(b,"_touchEnd")}),d.call(b)}}}(jQuery);</script>


    <script>
    var initial_set_list = [
        {% for song in set_songs %}
            {
                song_id: {{ song.id }},
                key_index: {{ song.key_index }}
            },
        {% endfor %}
    ];


    function onListChange()
    {
        var idsInOrder = $("#list-sortable").sortable("toArray");

        var new_set = [];
        for (let i = 0; i < idsInOrder.length; i++)
        {
            song_id = idsInOrder[i].split("_")[2];
            index = idsInOrder[i].split("_")[1];

            new_set.push({
                id: parseInt(song_id),
                key_index: parseInt($("#target-key_" + index)[0].value)
            });
        }

        $.ajax({
            type: 'POST',
            url: '{% url 'set.update' %}',
            headers: { "X-CSRFToken": '{{ csrf_token }}' },
            data: {new_set: JSON.stringify(new_set)},
            dataType: 'json'
        });
    }


    function clearList() {
        console.log("Clearing list");
        $.ajax({
            url: '{% url 'set.clear' %}',
            /* It seems ajax requires some data for it to work correctly */
            data: {clear: true},
            dataType: 'json',
            success: function (data) {
                location.reload();
            }
        });
    }


    $( function() {
        /* Set up sortable list */
        $("#list-sortable").sortable({
            update: onListChange,
            handle: '.handle'
        });
        $("#list-sortable").disableSelection();
        $("#list-sortable .set-item-delete").click(function() {$(this).parent().remove(); onListChange()});

        $("#btn-clear-set-list").click(clearList);

        for (let i = 0; i < initial_set_list.length; i++) {
            $("#target-key_" + i)[0].value = initial_set_list[i].key_index;
            $("#target-key_" + i).change(onListChange);
        }

        $('#name-read-only').text("{{ set.name }}");
        $('#input-set-name').val("{{ set.name }}");
        $('#name-edit').hide();
        $('#btn-rename').click(function() {
            $('#name-edit').show()
            $('#name-show').hide()
        });
        $('#btn-name-edit-done').click(function() {
            $.ajax({
                type: 'POST',
                url: '{% url 'set.rename' %}',
                headers: { "X-CSRFToken": '{{ csrf_token }}' },
                data: {
                    'name': $('#input-set-name').val(),
                },
                dataType: 'json',
                success: function(data) {
                    $('#name-read-only').text(data.new_name);
                    $('#input-set-name').val(data.new_name);
                    $('#name-edit').hide()
                    $('#name-show').show()
                }
            });
        });
    });
    </script>
</head>
<body>

    <h1>Set list{% if set_songs %} - <a href="{% url 'set.song' 0 %}">Go</a>{% endif %}</h1>

    <p>
        <span id="name-edit"><input id="input-set-name"><button id="btn-name-edit-done">Done</button></span>
        <span id="name-show"><span id="name-read-only"></span><button id="btn-rename">Rename</button></span>
    </p>

    <ul id="list-sortable">
        {% for song in set_songs %}
            <li id="set-item_{{ forloop.counter0 }}_{{ song.id }}">
                <span class="handle">HANDLE</span>
                <button class="set-item-delete">X</button>
                <a href="{% url 'song' song.id %}">{{ song.title }}</a> in

                <select id="target-key_{{ forloop.counter0 }}">
                {% for key in keys %}
                    <option value="{{ forloop.counter0 }}">{{ key }}</option>
                {% endfor %}
                </select>

            </li>
        {% endfor %}
    </ul>

    {% if set_songs %}
        <button id="btn-clear-set-list">Clear set list</button>
        <br>
        <a href="{% url 'set.print' set.pk %}">Print set</a>
    {% else %}
        Set list currently empty. Why not add some <a href="{% url 'songs' %}">songs</a>?
    {% endif %}

</body>
</html>
